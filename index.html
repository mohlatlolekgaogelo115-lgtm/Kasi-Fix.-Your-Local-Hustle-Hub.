<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KasiFix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        #toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 9999;
            max-width: 380px;
        }
        .toast {
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            margin-bottom: 12px;
        }
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        .toast.success { background: #10b981; color: white; }
        .toast.error   { background: #ef4444; color: white; }
        .toast.info    { background: #3b82f6; color: white; }
        .toast.warning { background: #f59e0b; color: white; }

        /* Dark mode styles */
        html.dark {
            --bg: #111827;
            --card: #1f2937;
            --text: #f3f4f6;
            --text-secondary: #9ca3af;
            --border: #374151;
        }
        html.light {
            --bg: #f9fafb;
            --card: #ffffff;
            --text: #111827;
            --text-secondary: #4b5563;
            --border: #d1d5db;
        }
        body {
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.3s, color 0.3s;
        }
        .bg-white { background-color: var(--card); }
        .text-gray-900 { color: var(--text); }
        .text-gray-700 { color: var(--text); }
        .text-gray-600 { color: var(--text-secondary); }
        .text-gray-500 { color: var(--text-secondary); }
        .border-gray-200 { border-color: var(--border); }
        .border-gray-300 { border-color: var(--border); }
        .bg-gray-50   { background-color: var(--card); }
        .shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); }

        /* Hover transitions */
        .card-hover {
            transition: all 0.2s ease;
        }
        .card-hover:hover {
            transform: translateY(-3px) scale(1.015);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }
        button:not([disabled]) {
            transition: all 0.15s ease;
        }
        button:not([disabled]):hover {
            transform: scale(1.03);
        }
    </style>
</head>
<body class="min-h-screen transition-colors duration-300">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Login Screen -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen px-4">
        <div class="bg-white rounded-3xl shadow-2xl p-10 max-w-md w-full text-center">
            <h1 class="text-4xl font-extrabold text-[#1e3a8a] mb-8">KasiFix Admin</h1>
            <p class="text-gray-600 mb-8">Sign in with Google to access the dashboard.</p>
           
            <button onclick="signInWithGoogle()" class="w-full bg-white border border-gray-300 text-gray-800 py-4 rounded-xl font-medium text-lg hover:bg-gray-50 transition shadow-md flex items-center justify-center gap-3 mb-6">
                <i class="fa-brands fa-google text-xl text-[#4285F4]"></i>
                Sign in with Google
            </button>

            <p class="text-xs text-gray-500 mt-6">Only authorized Google accounts can access this dashboard.</p>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
        <nav class="bg-white border-b sticky top-0 z-40 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center">
                        <span class="text-2xl font-extrabold text-[#1e3a8a]">KasiFix Admin</span>
                    </div>
                    <div class="flex items-center gap-6">
                        <button onclick="toggleDarkMode()" class="text-gray-600 hover:text-gray-900 text-xl" title="Toggle dark mode">
                            <i id="theme-icon" class="fa-solid fa-moon"></i>
                        </button>
                        <button onclick="logout()" class="text-gray-600 hover:text-red-600 font-medium">
                            <i class="fa-solid fa-arrow-right-from-bracket mr-2"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 py-12">
            <!-- Stats Section -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <div class="bg-white rounded-2xl shadow border border-gray-200 p-6 text-center">
                    <p class="text-sm text-gray-500">Total Hustlers</p>
                    <p id="stat-total" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                </div>
                <div class="bg-white rounded-2xl shadow border border-gray-200 p-6 text-center">
                    <p class="text-sm text-gray-500">Pending</p>
                    <p id="stat-pending" class="text-3xl font-bold text-yellow-600 mt-1">0</p>
                </div>
                <div class="bg-white rounded-2xl shadow border border-gray-200 p-6 text-center">
                    <p class="text-sm text-gray-500">Verified</p>
                    <p id="stat-verified" class="text-3xl font-bold text-green-600 mt-1">0</p>
                </div>
                <div class="bg-white rounded-2xl shadow border border-gray-200 p-6 text-center">
                    <p class="text-sm text-gray-500">Avg Hourly Rate</p>
                    <p id="stat-avg-rate" class="text-3xl font-bold text-[#f97316] mt-1">R0</p>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-6">
                <div>
                    <h2 class="text-3xl font-extrabold text-gray-900">Hustler Applications</h2>
                    <p class="text-gray-600">Manage and verify new hustler profiles.</p>
                </div>
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 text-right">
                    <button onclick="openAddModal()" class="bg-[#1e3a8a] text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-900 transition shadow">
                        <i class="fa-solid fa-plus mr-2"></i> Add Hustler
                    </button>
                    <div class="whitespace-nowrap">
                        <p class="text-sm text-gray-500">
                            Total registered hustlers: <span id="total-count">0</span><br>
                            Pending applications: <span id="pending-count">0</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white p-6 rounded-2xl shadow border border-gray-200 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                        <div class="relative">
                            <input type="text" id="search-input" placeholder="Name, phone, location..." class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-300 focus:border-[#f97316] outline-none" oninput="filterHustlers()">
                            <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <select id="category-filter" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#f97316] outline-none bg-white" onchange="filterHustlers()">
                            <option value="all">All Categories</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="admin-container" class="space-y-6 pb-20 relative">
                <div class="text-center py-20 text-gray-500">
                    <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4"></i>
                    <p class="text-lg">Loading applications...</p>
                </div>
            </div>

            <!-- Bulk action bar -->
            <div id="bulk-bar" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-2xl rounded-2xl px-6 py-4 hidden flex items-center gap-6 z-50 transition-all duration-200">
                <span id="bulk-count" class="font-medium text-gray-700 dark:text-gray-300"></span>
                <button onclick="bulkVerify(true)" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-xl font-medium transition">Verify Selected</button>
                <button onclick="bulkVerify(false)" class="bg-orange-500 hover:bg-orange-600 text-white px-5 py-2.5 rounded-xl font-medium transition">Unverify Selected</button>
                <button onclick="bulkDelete()" class="bg-red-600 hover:bg-red-700 text-white px-5 py-2.5 rounded-xl font-medium transition">Delete Selected</button>
                <button onclick="clearBulk()" class="text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 font-medium">Clear</button>
            </div>
        </div>
    </div>

    <!-- Add Hustler Modal -->
    <div id="add-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden px-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <h3 class="text-2xl font-bold text-gray-900">Add New Hustler</h3>
            </div>
            <div class="p-6 space-y-5">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                    <input type="text" id="new-name" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#f97316] outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                    <input type="text" id="new-category" placeholder="e.g. Plumber, Electrician, Cleaner" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#f97316] outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
                    <input type="tel" id="new-phone" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#f97316] outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                    <input type="text" id="new-location" placeholder="e.g. Soweto, Johannesburg" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#f97316] outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Hourly Rate (R)</label>
                    <input type="number" id="new-rate" placeholder="e.g. 250" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#f97316] outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Bio</label>
                    <textarea id="new-bio" rows="4" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#f97316] outline-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Profile Image URL (optional)</label>
                    <input type="url" id="new-image" placeholder="https://..." class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#f97316] outline-none">
                </div>
            </div>
            <div class="p-6 border-t flex justify-end gap-4">
                <button onclick="closeAddModal()" class="px-6 py-3 rounded-xl border border-gray-300 text-gray-700 font-medium hover:bg-gray-100 transition">Cancel</button>
                <button onclick="submitNewHustler()" class="px-6 py-3 rounded-xl bg-[#f97316] text-white font-bold hover:bg-orange-600 transition">Add Hustler</button>
            </div>
        </div>
    </div>

    <script>
        // Dark Mode Toggle
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('theme-icon').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            document.getElementById('theme-icon').className = 'fa-solid fa-sun';
        }

        // Firebase Config & Init (unchanged)
        const firebaseConfig = {
            apiKey: "AIzaSyC4kR_HiywObXho8Zh20JyzC40iVrZq3lo",
            authDomain: "kasifix-5b102.firebaseapp.com",
            projectId: "kasifix-5b102",
            storageBucket: "kasifix-5b102.firebasestorage.app",
            messagingSenderId: "800882399249",
            appId: "1:800882399249:web:f8ecdfb12fa98d7a5779b0",
            measurementId: "G-8NKED4DENK"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // Auth functions (unchanged)
        function signInWithGoogle() { /* ... unchanged ... */ }
        function logout() { /* ... unchanged ... */ }
        auth.onAuthStateChanged((user) => { /* ... unchanged ... */ });

        // Core variables & functions (mostly unchanged)
        const adminContainer = document.getElementById('admin-container');
        const totalCountEl = document.getElementById('total-count');
        const pendingCountEl = document.getElementById('pending-count');
        const statTotalEl = document.getElementById('stat-total');
        const statPendingEl = document.getElementById('stat-pending');
        const statVerifiedEl = document.getElementById('stat-verified');
        const statAvgRateEl = document.getElementById('stat-avg-rate');

        let allHustlers = [];
        let filteredHustlers = [];
        let selectedIds = new Set();

        function showToast(message, type = 'success') { /* ... unchanged ... */ }

        function loadHustlers() { /* ... unchanged ... */ }

        function updateStats() { /* ... unchanged ... */ }

        function populateCategoryFilter() { /* ... unchanged ... */ }

        function filterHustlers() { /* ... unchanged ... */ }

        function renderAdminHustlers() {
            const hustlersToShow = filteredHustlers;
            adminContainer.innerHTML = '';

            if (hustlersToShow.length === 0) {
                let msg = allHustlers.length === 0 
                    ? 'No hustlers have been added yet.<br>Use the "Add Hustler" button above to get started!'
                    : 'No hustlers match your current search or category filter.<br>Try different keywords or clear the filters.';
                
                let extra = allHustlers.length > 0 ? `
                    <button onclick="document.getElementById('search-input').value=''; document.getElementById('category-filter').value='all'; filterHustlers();" 
                            class="mt-6 px-6 py-3 bg-[#f97316] text-white rounded-xl font-medium hover:bg-orange-600 transition">
                        Reset Filters
                    </button>` : '';

                adminContainer.innerHTML = `
                    <div class="text-center py-24 text-gray-500">
                        <i class="fa-solid fa-${allHustlers.length === 0 ? 'inbox' : 'filter'} text-7xl mb-6 opacity-50"></i>
                        <p class="text-xl font-medium">${msg}</p>
                        ${extra}
                    </div>`;
                
                totalCountEl.textContent = allHustlers.length;
                pendingCountEl.textContent = allHustlers.filter(h => !h.verified).length;
                return;
            }

            const pending = allHustlers.filter(h => !h.verified).length;
            totalCountEl.textContent = allHustlers.length;
            pendingCountEl.textContent = pending;

            hustlersToShow.forEach(h => {
                const date = h.timestamp ? new Date(h.timestamp).toLocaleString('en-ZA') : 'Unknown';
                const statusClass = h.verified ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                const statusText = h.verified ? 'VERIFIED' : 'PENDING';
                const verifyBtnText = h.verified ? 'Unverify' : 'Verify';
                const verifyBtnClass = h.verified ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-600 hover:bg-green-700';
                const imageHtml = h.imageUrl
                    ? `<img src="${h.imageUrl}" alt="${h.name}" class="w-24 h-24 rounded-xl object-cover shadow">`
                    : `<div class="bg-gray-200 border-2 border-dashed rounded-xl w-24 h-24 flex items-center justify-center text-3xl font-bold text-gray-400">${h.name.charAt(0).toUpperCase()}</div>`;

                const card = `
                <div class="card-hover bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
                    <div class="p-6 flex flex-col md:flex-row">
                        <div class="mb-4 md:mb-0 md:mr-8">
                            ${imageHtml}
                        </div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="text-xl font-extrabold text-gray-900">${h.name || 'No name'}</h3>
                                    <p class="text-[#f97316] font-semibold">${h.category || 'No category'}</p>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs font-bold ${statusClass}">
                                    ${statusText}
                                </span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600 mb-4">
                                <p><i class="fa-solid fa-phone mr-2"></i> ${h.phone || 'No phone'}</p>
                                <p><i class="fa-solid fa-location-dot mr-2"></i> ${h.location || 'No location'}</p>
                                <p><i class="fa-solid fa-sack-dollar mr-2"></i> R${h.rate || '0'}/hr</p>
                                <p><i class="fa-solid fa-calendar mr-2"></i> ${date}</p>
                            </div>
                            <p class="text-gray-700 bg-gray-50 p-4 rounded-xl border border-gray-100"><strong>Bio:</strong> ${h.bio || 'No bio provided'}</p>
                        </div>
                        <div class="ml-0 md:ml-8 mt-6 md:mt-0 flex flex-row md:flex-col gap-4 items-start md:items-end">
                            <input type="checkbox" class="w-5 h-5 mt-1.5 accent-[#f97316]" onchange="toggleSelection('${h.id}', this.checked)">
                            <button onclick="toggleVerify('${h.id}', ${!h.verified})" class="px-6 py-3 rounded-xl text-white font-bold transition ${verifyBtnClass}">
                                ${verifyBtnText}
                            </button>
                            <button onclick="deleteHustler('${h.id}')" class="px-6 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 transition">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>`;
                adminContainer.innerHTML += card;
            });
        }

        // Bulk selection helpers
        function toggleSelection(id, isChecked) {
            if (isChecked) {
                selectedIds.add(id);
            } else {
                selectedIds.delete(id);
            }
            updateBulkBar();
        }

        function updateBulkBar() {
            const count = selectedIds.size;
            const bar = document.getElementById('bulk-bar');
            const text = document.getElementById('bulk-count');

            if (count > 0) {
                text.textContent = `${count} selected`;
                bar.classList.remove('hidden');
            } else {
                bar.classList.add('hidden');
            }
        }

        function clearBulk() {
            selectedIds.clear();
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateBulkBar();
        }

        async function bulkVerify(shouldVerify) {
            if (selectedIds.size === 0) return;
            const action = shouldVerify ? 'verify' : 'unverify';
            if (!confirm(`Are you sure you want to ${action} ${selectedIds.size} hustler(s)?`)) return;

            const updates = {};
            selectedIds.forEach(id => {
                updates[`hustlers/${id}/verified`] = shouldVerify;
            });

            try {
                await db.ref().update(updates);
                showToast(`Successfully ${action}ed ${selectedIds.size} hustler(s)`, 'success');
                clearBulk();
            } catch (err) {
                showToast('Bulk action failed: ' + err.message, 'error');
            }
        }

        async function bulkDelete() {
            if (selectedIds.size === 0) return;
            if (!confirm(`Permanently delete ${selectedIds.size} hustler(s)? This cannot be undone.`)) return;

            try {
                const promises = [...selectedIds].map(id => db.ref(`hustlers/${id}`).remove());
                await Promise.all(promises);
                showToast(`${selectedIds.size} hustler(s) deleted`, 'success');
                clearBulk();
            } catch (err) {
                showToast('Bulk delete failed: ' + err.message, 'error');
            }
        }

        // Rest of functions unchanged
        function toggleVerify(id, makeVerified) { /* ... */ }
        function deleteHustler(id) { /* ... */ }
        function confirmDelete(id, toastElement) { /* ... */ }
        function openAddModal() { /* ... */ }
        function closeAddModal() { /* ... */ }
        function submitNewHustler() { /* ... */ }

        // Load on auth
        loadHustlers();  // Note: in real use this is called after login
    </script>
</body>
</html>

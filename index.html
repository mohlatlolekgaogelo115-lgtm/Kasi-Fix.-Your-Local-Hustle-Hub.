<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KasiFix | Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .no-scroll { overflow: hidden; }
        table { border-collapse: separate; border-spacing: 0; }
        th { position: sticky; top: 0; background: white; z-index: 10; }
        tr:hover { background-color: #f9fafb; }
        .truncate-text { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        @media (max-width: 768px) {
            .truncate-text { max-width: 120px; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Simple Password Protection (client-side only – for basic obfuscation) -->
    <script>
        const adminPassword = "kasifixadmin2026"; // CHANGE THIS TO SOMETHING STRONG
        const entered = prompt("Enter Admin Password:");
        if (entered !== adminPassword) {
            alert("Access denied.");
            window.location.href = "about:blank";
        }
    </script>

    <nav class="bg-white border-b sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center">
                    <span class="text-2xl font-extrabold text-[#1e3a8a]">Kasi<span class="text-[#f97316]">Fix</span> <span class="text-sm font-medium text-gray-500 ml-2">| Admin Dashboard</span></span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="./index.html" class="text-gray-600 hover:text-blue-900 font-medium">Public Site</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-12">
        <div class="mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Admin Dashboard</h1>
            <p class="text-gray-600">Manage and verify hustler applications.</p>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Hustlers</p>
                        <p id="total" class="text-3xl font-extrabold text-gray-900">0</p>
                    </div>
                    <i class="fa-solid fa-users text-3xl text-blue-600"></i>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Verified</p>
                        <p id="verified" class="text-3xl font-extrabold text-green-600">0</p>
                    </div>
                    <i class="fa-solid fa-check-circle text-3xl text-green-600"></i>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Pending</p>
                        <p id="pending" class="text-3xl font-extrabold text-orange-600">0</p>
                    </div>
                    <i class="fa-solid fa-clock text-3xl text-orange-600"></i>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Today</p>
                        <p id="today" class="text-3xl font-extrabold text-gray-900">0</p>
                    </div>
                    <i class="fa-solid fa-calendar-day text-3xl text-blue-600"></i>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Photo</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Phone</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Category</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Location</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Rate</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Bio</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Submitted</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="10" class="text-center py-12 text-gray-500"><i class="fa-solid fa-circle-notch fa-spin text-2xl"></i> Loading hustlers...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // Firebase Configuration (same as public site)
        const firebaseConfig = {
            apiKey: "AIzaSyC4kR_HiywObXho8Zh20JyzC40iVrZq3lo",
            authDomain: "kasifix-5b102.firebaseapp.com",
            projectId: "kasifix-5b102",
            storageBucket: "kasifix-5b102.firebasestorage.app",
            messagingSenderId: "800882399249",
            appId: "1:800882399249:web:f8ecdfb12fa98d7a5779b0",
            measurementId: "G-8NKED4DENK"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allHustlers = [];

        // Real-time listener
        db.ref('hustlers').on('value', (snapshot) => {
            const data = snapshot.val() || {};
            allHustlers = Object.keys(data).map(key => ({ id: key, ...data[key] }));
            // Sort newest first
            allHustlers.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            renderTable();
            updateStats();
        });

        function updateStats() {
            const total = allHustlers.length;
            const verified = allHustlers.filter(h => h.verified).length;
            const pending = total - verified;

            const today = new Date().setHours(0,0,0,0);
            const todayCount = allHustlers.filter(h => h.timestamp && new Date(h.timestamp).setHours(0,0,0,0) === today).length;

            document.getElementById('total').innerText = total;
            document.getElementById('verified').innerText = verified;
            document.getElementById('pending').innerText = pending;
            document.getElementById('today').innerText = todayCount;
        }

        function renderTable() {
            const tbody = document.getElementById('admin-table-body');
            if (allHustlers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center py-12 text-gray-500">No hustlers registered yet.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            allHustlers.forEach(h => {
                const date = h.timestamp ? new Date(h.timestamp).toLocaleString('en-ZA') : '—';
                const imgHtml = h.imageUrl 
                    ? `<img src="${h.imageUrl}" alt="${h.name}" class="w-12 h-12 rounded-xl object-cover border">`
                    : `<div class="w-12 h-12 bg-gray-200 rounded-xl flex items-center justify-center text-xl font-bold text-gray-600">${h.name.charAt(0).toUpperCase()}</div>`;

                const verifiedChecked = h.verified ? 'checked' : '';
                const statusText = h.verified ? '<span class="text-green-600 font-medium">Verified</span>' : '<span class="text-orange-600 font-medium">Pending</span>';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4">${imgHtml}</td>
                    <td class="px-6 py-4 font-semibold text-gray-900">${h.name || '—'}</td>
                    <td class="px-6 py-4">${h.phone || '—'}</td>
                    <td class="px-6 py-4">${h.category || '—'}</td>
                    <td class="px-6 py-4">${h.location || '—'}</td>
                    <td class="px-6 py-4">R${h.rate || '—'}/hr</td>
                    <td class="px-6 py-4"><span class="truncate-text" title="${h.bio || ''}">${h.bio || '—'}</span></td>
                    <td class="px-6 py-4 text-sm text-gray-500">${date}</td>
                    <td class="px-6 py-4">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" ${verifiedChecked} onchange="toggleVerified('${h.id}', this.checked)" class="w-5 h-5 text-orange-600 rounded focus:ring-orange-500">
                            ${statusText}
                        </label>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="deleteHustler('${h.id}')" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition text-sm">
                            Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function toggleVerified(id, checked) {
            db.ref('hustlers/' + id).update({ verified: checked });
        }

        function deleteHustler(id) {
            if (confirm("Permanently delete this hustler? This cannot be undone.")) {
                db.ref('hustlers/' + id).remove();
            }
        }
    </script>
</body>
</html>
